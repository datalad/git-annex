name: Update mirror

on:
  schedule:
    - cron: '0 */2 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: upstream/master

      - name: Fetch updates from official repository
        run: |
          git config pull.ff only
          git remote add official git://git.kitenet.net/git-annex
          git pull --tags official master

      - name: Determine new tags
        run: |
          comm -23 <(git tag | sort) \
                   <(git ls-remote --tags --refs origin \
                    | awk '{print $2}' \
                    | xargs git for-each-ref --format '%(refname:strip=2)' \
                    | sort) > new-tags.txt

      - name: Push new objects to mirror
        run: git push --tags origin upstream/master

      - name: Use python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip pip-run wheel
          # No quotes around substitution:
          ### Currently broken <https://github.com/jaraco/pip-run/issues/46>,
          ### so the dependencies have to copied here for now.
          #python -m pip install $(python -m pip_run.read-deps .github/workflows/tools/dispatch-build)
          python -m pip install "click ~= 7.0" "PyGithub == 1.*"

      - name: Trigger workflow runs for new tags
        run: |
          while read tag
          do python .github/workflows/tools/dispatch-build "$tag"
          done < new-tags.txt
        env:
          GITHUB_TOKEN: ${{ secrets.DATALAD_GITHUB_TOKEN }}

# vim:set sts=2:
