name: Update mirror

on:
  schedule:
    - cron: '0 */2 * * *'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: upstream/master

      - name: Fetch updates from official repository
        run: |
          git config pull.ff only
          git remote add official git://git.kitenet.net/git-annex
          git pull --tags official master

      - name: Determine new tags
        run: |
          comm -23 <(git tag | sort) \
                   <(git ls-remote --tags --refs origin \
                    | awk '{print $2}' \
                    | xargs git for-each-ref --format '%(refname:strip=2)' \
                    | sort) > new-tags.txt

      - name: Push new objects to mirror
        run: git push --tags origin upstream/master

      - name: Trigger workflow runs for new tags
        run: |
          while read tag
          do for workflow in build-macos.yaml build-ubuntu.yaml build-windows.yaml
             do jq -n --arg tag "$tag" '{ref: "master", inputs: {commitish: $tag}}' | \
                curl -fsSL -X POST -d@- \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
                  https://api.github.com/repos/datalad/git-annex/actions/workflows/"$workflow"/dispatches
             done
          done < new-tags.txt

# vim:set sts=2:
