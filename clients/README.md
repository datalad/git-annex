Testing git-annex Builds on Local Clients
=========================================

In order to test our builds of git-annex on non-GitHub servers (hereafter
"clients") without the use of a GitHub Actions self-hosted runner, we have
established the following setup:

- The file `clients/clients.yaml` in this repository stores a list of client
  IDs and other per-client information

- The GitHub Actions build job pushes its built Debian binary packages to
  [datalad/git-annex-ci-client-jobs](https://github.com/datalad/git-annex-ci-client-jobs)
  by creating a `build-$CLIENTID-$BUILDNO` branch for each client containing
  only the build's `*.deb` file

- On each client, a cronjob is established that fetches the `build-*` branches
  for that client; for each branch fetched, the `*.deb` is installed, tests are
  run, the results are saved to a `result-$CLIENTID-$BUILDNO` branch, and the
  original branch is deleted.

- A workflow on datalad/git-annex-ci-client-jobs is established that is run
  whenever a `result-*` branch is pushed to.  This workflow uses the latest
  result statuses to create SVG badges (via shields.io) and save them in the
  repository; uploads the contents of the `result-*` branches as build
  artifacts for fetching with [tinuous](https://github.com/con/tinuous); and
  deletes the `result-*` branch.

- A table (generated by `mktable.py`) is added to the main README in this
  repository displaying the SVG badges from datalad/git-annex-ci-client-jobs.

Currently, only testing on Debian-based systems is supported.

Setting up a New Client
-----------------------

- Determine a unique ID for the client.  Client IDs should consist of only
  ASCII letters, numbers, underscores, and/or hyphens. E.g. could simply correspond
  to output of `hostname` command.

- Add an entry to `clients.yaml` for the client containing one or more tests
  (See "`clients.yaml` Format" below)

- Set up permissions for the client to be able to pull from & write to
  datalad/git-annex-ci-client-jobs

- On the client:

    - Configure a name & e-mail in Git

    - Clone this repository.  Passing `--single-branch` is recommended so as
      not to include the mirror of git-annex's repository. E.g.,

            git clone --single-branch http://github.com/datalad/git-annex ~/git-annex-ci/git-annex

    - Import `.github/workflows/tools/datalad-builder-key.asc` into GPG

            cd ~/git-annex-ci/git-annex
            gpg --import < .github/workflows/tools/datalad-builder-key.asc

    - Create a Python virtual environment in this directory in the clone and
      install the packages listed in `requirements.txt` in it, e.g.

            cd ~/git-annex-ci/git-annex/clients
            python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt

        - Alternatively, create a conda environment named "`testannex`" using
          the `environment.yml` file in this directory

    - Create a cronjob with a command of the form:

            cd /path/to/clone/clients && chronic flock -n -E 0 .lock venv/bin/python testannex.py CLIENTID /path/to/job/dir

      where `CLIENTID` is replaced by the ID of the client and
      `/path/to/job/dir` is replaced by the path to the location at which to
      clone the jobs repository, e.g.

            0 * * * * cd ~/git-annex-ci/git-annex/clients && chronic flock -n -E 0 .lock venv/bin/python testannex.py `hostname` ~/git-annex-ci/jobs

        - Alternatively, if using Conda:

                cd /path/to/clone/clients && chronic flock -n -E 0 .lock ./testannex.sh CLIENTID /path/to/job/dir

- Edit the `README.md` in the root of this repository to add badges for the
  client's overall test status and per-test statuses.  (Badges will not be
  available until the client has finished at least one job whose results were
  successfully processed by datalad/git-annex-ci-client-jobs.)


`clients.yaml` Format
---------------------

The client configuration file consists of a YAML mapping in which the keys are
client IDs and the values are sub-mappings with the following fields:

- `tests` — A mapping in which the keys are test names and each value is the
  body of a script to run for the test.  The test scripts are run in an
  environment with the following properties:

    - git-annex is installed to a temporary location, the `bin` folder of which
      is prepended to `PATH`

    - The environment variable `BUILDNO` is set to the run number of the
      `build-ubuntu.yaml` workflow that produced the package

    - The current working directory is set to the `clients/` directory in the
      clone of this repository

- `shell` — A string giving the path to the shell to use to run the test
  bodies; defaults to `"/bin/bash"`
