[[!comment format=mdwn
 username="joey"
 subject="""comment 2"""
 date="2023-09-22T17:37:50Z"
 content="""
Was a bit tricky to reproduce this (which does not excuse forgetting about
it for 5 years!)

	export LANG=en_US.utf8
	git init foo
	cd foo
	export GIT_AUTHOR_NAME=FÃ©lix
	git-annex init
	touch foo
	git-annex add
	git commit -m add
	unset GIT_AUTHOR_NAME
	export LANG=C
	git-annex adjust --unlock

What seems to be happening is that catCommit gets:

	commitName = Just "F\56515\56489lix"

Which is I think ok, that's a utf-8 surrogate in the filesystem encoding.
Then that's passed into commitWithMetaData, which sets the environment
variable to its content. And apparently it fails to be converted back to
the right bytes.

One fix would be to keep it a ByteString all the way though, using
`System.Posix.Env.ByteString`. I tried converting all environment in
git-annex to use that, but CreateProcess uses String for env, so that is
not really possible. Also it's pretty intrusive, and is problimatic for
Windows since it would have to decode the ByteString back to String.
So while this would be best -- it would ensure that any environment
variable that for some reason needs to get set by git-annex would
not incur mojibake -- it doesn't seem possible with the current library
ecosystem.

I tried making commitWithMetaData set the env var to a String that
had the filesystem encoding applied. Eg `w82s (S.unpack (encodeBS v))`.
Interestingly, that failed:

git-annex: git: recoverEncode: invalid argument (cannot encode character '\195')

Which looks like the filesystem encoding is being applied after all?
And in System.Process.Posix, it does look like it does,
withCEnvironment uses withFilePath on the contents of env.

So huh, why then does the value not roundtrip?
"""]]
